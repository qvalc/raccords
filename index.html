<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Raccords plomberie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      margin: 0;
      padding: 20px;
    }

    h2 {
      margin-top: 40px;
      border-bottom: 2px solid #eee;
      padding-bottom: 5px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: #fff;
    }

    .card img {
      width: 100%;
      height: 140px;
      object-fit: contain;
    }

    .title {
      font-size: 14px;
      font-weight: bold;
      margin: 6px 0;
    }

    select, input {
      width: 100%;
      margin-top: 4px;
      padding: 4px;
    }

    .price {
      margin-top: 6px;
      font-weight: bold;
    }

    .error {
      color: red;
      font-size: 12px;
      margin-top: 4px;
    }
  </style>
</head>

<body>

<h1>Raccords plomberie</h1>

<div id="app"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* =========================
   CONFIG
========================= */

const MANIFEST_URL = "prix/manifest.json";

/* Images par catégorie */
const IMAGES = {
  "a-souder": [],
  "bicones": [],
  "laiton": [
    "allonge.png","bouchon.png","coude-f-f.png","coude-m-f.png",
    "coude-union.png","union-coudee.png","laiton-bonnet.png",
    "laiton-culasse.png","laiton-manchon.png","nipple.png",
    "nipple-reduite.png","rac-union.png","reduction-f-f.png",
    "reduction-f-m.png","reduction-t-f.png","te-egal.png",
    "tes-1.png","tes-2.png","tes-3.jpg","tetine-femelle.png",
    "tetine-male.png"
  ],
  "collecteurs": [
    "collecteur-2-bleu.png","collecteur-2-rouge.png",
    "collecteur-3-bleu.png","collecteur-3-rouge.png",
    "collecteur-4-bleu.png","collecteur-4-rouge.png",
    "collecteur-5-bleu.png","collecteur-5-rouge.png",
    "collecteur-6-bleu.png","collecteur-6-rouge.png"
  ],

  /* ✅ GEKA ajouté */
  "geka": [
    "rac-geka-F.png",
    "rac-geka-M.png",
    "rac-geka-T.png"
  ],

  "pex-a-sertir": [],
  "pex": [],
  "push": []
};

/* Tailles fallback (sécurité) */
const CAT_SIZES = {
  "bicones": ["3/8","1/2","3/4","4/4","5/4"],
  "laiton": ["3/8","1/2","3/4","4/4","5/4"],
  "collecteurs": [
    "3/4-2","3/4-3","3/4-4","3/4-5","3/4-6",
    "4/4-2","4/4-5"
  ],
  "geka": ["1/2","3/4"],
  "pex-a-sertir": ["Ø16","Ø20","Ø26"],
  "pex": ["Ø16","Ø20","Ø26"],
  "push": ["Ø16","Ø20"]
};

/* =========================
   DONNÉES PRIX
========================= */

const PRICE_MAP = {};
const SIZES_BY_PATH = {};

/* =========================
   UTILS
========================= */

function getStoredSize(path, fallback) {
  return localStorage.getItem("size:" + path) || fallback;
}

function setStoredSize(path, size) {
  localStorage.setItem("size:" + path, size);
}

function getSizeOptions(cat, pathKey) {
  if (SIZES_BY_PATH[pathKey]?.length) {
    return SIZES_BY_PATH[pathKey];
  }
  return CAT_SIZES[cat] || [];
}

/* =========================
   LOAD EXCELS
========================= */

async function loadPrices() {
  const res = await fetch(MANIFEST_URL);
  const files = await res.json();

  for (const file of files) {
    const wb = XLSX.read(await (await fetch("prix/" + file)).arrayBuffer(), { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);

    rows.forEach(r => {
      let path = String(r.path || "").trim();
      if (!path) return;

      path = path.replace(/^collecteur\//, "collecteurs/");
      const size = String(r.taille || "").trim();
      const price = parseFloat(String(r.prix_tvac || "").replace(",", "."));

      if (!size || isNaN(price)) return;

      const key = path + "|" + size;
      PRICE_MAP[key] = price;

      if (!SIZES_BY_PATH[path]) SIZES_BY_PATH[path] = [];
      if (!SIZES_BY_PATH[path].includes(size)) {
        SIZES_BY_PATH[path].push(size);
      }
    });
  }
}

/* =========================
   RENDER
========================= */

function render() {
  const app = document.getElementById("app");
  app.innerHTML = "";

  Object.entries(IMAGES).forEach(([cat, imgs]) => {
    if (!imgs.length) return;

    const h = document.createElement("h2");
    h.textContent = cat;
    app.appendChild(h);

    const grid = document.createElement("div");
    grid.className = "grid";

    imgs.forEach(img => {
      const path = `${cat}/${img}`;
      const card = document.createElement("div");
      card.className = "card";

      const image = document.createElement("img");
      image.src = path;
      image.onerror = () => {
        image.style.display = "none";
        card.insertAdjacentHTML("beforeend",
          `<div class="error">❌ Introuvable : ${path}</div>`);
      };

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = img.replace(/\.(png|jpg)$/i,"");

      const sizes = getSizeOptions(cat, path);
      const select = document.createElement("select");

      sizes.forEach(s => {
        const o = document.createElement("option");
        o.value = s;
        o.textContent = s;
        select.appendChild(o);
      });

      const defaultSize = sizes[0] || "";
      let current = getStoredSize(path, defaultSize);
      if (!sizes.includes(current)) current = defaultSize;
      select.value = current;

      const price = document.createElement("div");
      price.className = "price";

      function updatePrice() {
        setStoredSize(path, select.value);
        const key = path + "|" + select.value;
        price.textContent = PRICE_MAP[key]
          ? PRICE_MAP[key].toFixed(2) + " € TVAC"
          : "—";
      }

      select.addEventListener("change", updatePrice);
      updatePrice();

      card.append(image, title, select, price);
      grid.appendChild(card);
    });

    app.appendChild(grid);
  });
}

/* =========================
   INIT
========================= */

(async () => {
  await loadPrices();
  render();
})();
</script>

</body>
</html>
