<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Raccords plomberie — Galerie</title>
  <style>
    body{font-family:Arial, sans-serif; margin:20px; line-height:1.4}
    header{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:18px}
    input[type="search"]{padding:10px 12px; border:1px solid #ccc; border-radius:10px; min-width:260px}
    select{padding:10px 12px; border:1px solid #ccc; border-radius:10px}
    h1{margin:0}
    h2{margin:28px 0 12px}

    /* ✅ grille */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
      gap:14px;
      align-items:stretch; /* important */
    }

    /* ✅ carte uniforme + prix en bas */
    figure{
      margin:0;
      border:1px solid #e1e1e1;
      border-radius:12px;
      padding:10px;
      background:#fff;

      display:flex;          /* NEW */
      flex-direction:column; /* NEW */
      height:100%;           /* NEW */
    }

    /* ✅ zone image identique partout */
    .thumb{
      height:160px;                 /* ajuste si tu veux (140/180/200) */
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      border-radius:10px;
      background:#fff;
    }
    .thumb img{
      max-width:100%;
      max-height:100%;
      width:auto;
      height:auto;
      display:block;
      border-radius:10px;
    }

    figcaption{font-size:13px; margin-top:8px; word-break:break-word}
    .muted{color:#666; font-size:13px}
    .missing{font-size:12px; color:#c00; margin-top:8px}

    /* ✅ prix aligné en bas */
    .price{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:auto;      /* NEW : pousse le bloc prix en bas */
      padding-top:10px;     /* NEW : espace régulier */
    }

    .price label{font-size:12px; color:#333}
    .price input{width:110px; padding:8px 10px; border:1px solid #ccc; border-radius:10px}
    .price .eur{font-size:12px; color:#555}

    .bar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid #e1e1e1; border-radius:999px; font-size:13px; background:#fff}
    .dot{width:8px; height:8px; border-radius:999px; background:#bbb}
    .dot.ok{background:#2e7d32}
    .dot.bad{background:#c62828}
  </style>
</head>
<body>

<header class="bar">
  <h1>Raccords plomberie — Galerie</h1>

  <select id="cat"></select>
  <input id="q" type="search" placeholder="Rechercher (ex: coude, té, 16, 20…)" />
  <span class="muted" id="count"></span>

  <span class="pill" title="Lecture du fichier prix.xlsx à la racine du dépôt">
    <span id="priceDot" class="dot"></span>
    <span id="priceStatus">Prix : en attente…</span>
  </span>
</header>

<div id="app"></div>

<!-- Librairie pour lire le fichier Excel (xlsx) dans le navigateur -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/** 1) Liste des images (PNG uniquement) */
const IMAGES = {
  "a-souder": [
    "coude-femelle.png","coude-male.png","coude-union-femelle.png","coude-union-male.png",
    "rac-femelle.png","rac-male.png","union-femelle.png","union-male.png"
  ],
  "acc-tube-polyethylene/huot": ["coude.png","manchon.png","rac-femelle.png","rac-male.png","te.png"],
  "acc-tube-polyethylene/plasson": ["coude.png","manchon.png","rac-femelle.png","rac-male.png","te.png"],
  "acc-tube-polyethylene/rexuo": ["coude.png","manchon.png","rac-femelle.png","rac-male.png","te.png"],

  "bicones": [
    "coude-femelle.png","coude-ff.png","coude-male.png","manchon-reduit.png",
    "manchon.png","rac-femelle.png","rac-male.png","te-egal.png"
  ],

  "laiton": [
    "allonge.png","bouchon.png","coude-f-f.png","coude-m-f.png","coude-union.png",
    "nipple-reduite.png","nipple.png","rac-union.png","reduction-f-f.png","reduction-f-m.png",
    "te-egal.png","tes-1.png","tes-2.png","tetine-femelle.png","tetine-male.png"
  ],

  "pex-a-sertir": [
    "bouchon-2.png","bouchon.png",
    "collecteur-2-bleu.png","collecteur-2-rouge.png",
    "collecteur-3-bleu.png","collecteur-3-rouge.png",
    "collecteur-4-bleu.png","collecteur-4-rouge.png",
    "collecteur-5-bleu.png","collecteur-5-rouge.png",
    "collecteur-6-bleu.png","collecteur-6-rouge.png",
    "coude-egal.png","coude-femelle-el.png","coude-femelle.png","coude-male.png",
    "culasse-double.png","culasse-simple.png","manchon.png","rac-femelle-el.png",
    "raccord-femelle.png","raccord-male.png",
    "te-egal.png","te-femelle.png","te-male.png","te-reduit.png"
  ],

  "pex": [
    "bouchon.png","coude-f-el.png","coude-femelle.png","coude-male.png",
    "culasse-doucle.png","culasse-simple.png","manchon.png",
    "raccord-f-el.png","raccord-femelle.png","raccord-male.png",
    "te-femelle.png","te-male.png","te-reduit.png","te.png","vanne.png"
  ],

  "push": [
    "bague-de-montage.png","bouchon.png","coude-egal.png","coude-femelle-el.png","coude-male.png",
    "culasse.png","insert.png","jonction-reduite.png","manchon.png","rac-femelle-el.png","rac-male.png",
    "te-egal.png","te-femelle.png","te-male.png","te-reduit.png","vanne-ecrou-libre.png"
  ]
};

/** 2) Où se trouve ton fichier Excel des prix (à la racine du dépôt) */
const PRICE_XLSX_URL = "prix.xlsx";

/** 3) Stockage des prix chargés depuis l’Excel */
let PRICE_MAP = Object.create(null);

// UI
const app = document.getElementById("app");
const catSel = document.getElementById("cat");
const q = document.getElementById("q");
const count = document.getElementById("count");
const priceStatus = document.getElementById("priceStatus");
const priceDot = document.getElementById("priceDot");

const categories = Object.keys(IMAGES);

catSel.innerHTML =
  `<option value="__all__">Toutes les catégories</option>` +
  categories.map(c => `<option value="${c}">${c}</option>`).join("");

function setPriceIndicator(ok, text){
  priceStatus.textContent = text;
  priceDot.className = "dot" + (ok ? " ok" : " bad");
}

/** Lit prix.xlsx et remplit PRICE_MAP */
async function loadPricesXlsx(){
  try{
    setPriceIndicator(false, "Prix : chargement…");
    const res = await fetch(PRICE_XLSX_URL, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);

    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    if(!ws) throw new Error("Feuille Excel introuvable");

    const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

    const map = Object.create(null);
    let count = 0;

    for(const r of rows){
      const path = String(r.path || r.Path || r.PATH || "").trim();
      let price = r.prix_tvac ?? r.Prix_TVAC ?? r.PRIX_TVAC ?? r.prix ?? r.Prix ?? "";
      if(!path) continue;

      if(typeof price === "string") price = price.replace(",", ".").trim();
      const num = Number(price);

      if(Number.isFinite(num)){
        map[path] = num;
        count++;
      }
    }

    PRICE_MAP = map;
    setPriceIndicator(true, `Prix : ${count} valeur(s) chargée(s)`);
  }catch(e){
    PRICE_MAP = Object.create(null);
    setPriceIndicator(false, `Prix : fichier introuvable ou invalide (${PRICE_XLSX_URL})`);
  }
}

function formatPrice(v){
  if(!Number.isFinite(v)) return "";
  return (Math.round(v * 100) / 100).toFixed(2);
}

function render(){
  const selected = catSel.value;
  const query = q.value.trim().toLowerCase();

  let total = 0;
  let html = "";

  for(const cat of categories){
    if(selected !== "__all__" && cat !== selected) continue;

    const files = (IMAGES[cat] || []).filter(f => f.toLowerCase().includes(query));
    if(!files.length) continue;

    total += files.length;
    html += `<h2>${cat}</h2><div class="grid">`;

    for(const f of files){
      const src = `${cat}/${encodeURIComponent(f)}`;
      const label = f.replace(/\.png$/i, "");
      const key = `${cat}/${f}`;
      const price = PRICE_MAP[key];

      html += `
        <figure>
          <a class="thumb" href="${src}" target="_blank" rel="noopener">
            <img src="${src}" alt="${label}"
              onerror="this.style.display='none'; this.closest('figure').insertAdjacentHTML('beforeend','<div class=\\'missing\\'>❌ Introuvable : ${src}</div>')">
          </a>

          <figcaption>${label}</figcaption>

          <div class="price">
            <label for="p_${btoa(key).replace(/=+/g,'')}">Prix TVAC</label>
            <input
              id="p_${btoa(key).replace(/=+/g,'')}"
              type="text"
              inputmode="decimal"
              value="${price !== undefined ? formatPrice(price) : ""}"
              placeholder="—"
              readonly
              title="Prix chargé depuis prix.xlsx (modifiable via Excel)"
            />
            <span class="eur">€</span>
          </div>
        </figure>
      `;
    }

    html += `</div>`;
  }

  app.innerHTML = html || `<p class="muted">Aucune image à afficher.</p>`;
  count.textContent = total ? `${total} image(s)` : "";
}

catSel.addEventListener("change", render);
q.addEventListener("input", render);

(async function init(){
  await loadPricesXlsx();
  render();
})();
</script>

</body>
</html>
